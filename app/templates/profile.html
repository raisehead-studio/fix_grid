<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å€‹äººè³‡æ–™</title>
  <!-- <script>
    const currentUser = {{ {
      "id": current_user.id,
      "username": current_user.username,
      "full_name": current_user.full_name,
      "role_id": current_user.role_id,
      "role_name": current_user.role_name,
      "district_id": current_user.district_id,
      "district": current_user.district,
      "village": current_user.village,
      "phone": current_user.phone
    } | tojson }};
    const userPermissions = {{ user_permissions | tojson }};
  </script> -->
  <script src="/static/js/tailwindcss.js"></script>
</head>
<body class="bg-gray-100">
  {% include 'navigation.html' %}
  <div class="p-4 flex justify-between">
    <h2 class="text-2xl font-bold">å€‹äººè³‡æ–™</h2>
  </div>
  <div class="max-w-xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold flex items-center justify-between">
      Hello, {{ current_user.full_name }}
      <button onclick="openEditModal()" class="text-blue-500 hover:text-blue-700">âœï¸</button>
    </h2>

    <div class="mt-4 space-y-2">
      {% if current_user.phone %}
        <p><strong>é›»è©±ï¼š</strong>{{ current_user.phone }}</p>
      {% endif %}
      {% if current_user.district %}
        <p><strong>è¡Œæ”¿å€ï¼š</strong>{{ current_user.district }}</p>
      {% endif %}
      {% if current_user.ip %}
        <p><strong>ç™»å…¥ IPï¼š</strong>{{ current_user.ip }}</p>
      {% endif %}
      
      <!-- é›™å› ç´ èªè­‰ç‹€æ…‹é¡¯ç¤º -->
      <div class="mt-4 p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-gray-900">é›™å› ç´ èªè­‰ (2FA)</p>
            <p class="text-sm text-gray-600" id="2fa-status-text">æª¢æŸ¥ä¸­...</p>
          </div>
          <button onclick="open2FAModal()" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
            ç®¡ç† 2FA
          </button>
        </div>
      </div>
      
      <div class="mt-6">
        <button onclick="showOwnLoginLogs()" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800">æŸ¥çœ‹ç™»å…¥è¨˜éŒ„</button>
      </div>
      
      <!-- ç³»çµ±ç®¡ç†å“¡ IP é–å®šç®¡ç† -->
      {% if current_user.role_id == 1 %}
      <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="text-lg font-semibold text-red-800">ğŸ”’ IP é–å®šç®¡ç†</h3>
            <p class="text-sm text-red-600">ç®¡ç†è¢«é–å®šçš„ IP åœ°å€</p>
          </div>
          <button onclick="showIPLockoutManagement()" class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
            ç®¡ç† IP é–å®š
          </button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ç·¨è¼¯ Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <form id="editForm"
        action="{{ url_for('account_bp.profile') }}"
        method="POST"
        class="bg-white p-6 rounded shadow w-full max-w-md space-y-4">
      <h3 class="text-xl font-bold">ä¿®æ”¹å€‹äººè³‡æ–™</h3>

      <div>
        <label for="phone" class="block text-sm font-medium mb-1">é›»è©±</label>
        <input id="phone" name="phone" class="w-full border p-2" value="{{ current_user.phone }}" required>
      </div>

      <div>
        <label for="district" class="block text-sm font-medium mb-1">è¡Œæ”¿å€</label>
        <select id="district" name="district" class="w-full border p-2" required></select>
      </div>

      <hr class="my-2">
      <p class="text-gray-600 text-sm">å¦‚éœ€ä¿®æ”¹å¯†ç¢¼ï¼Œè«‹å¡«å¯«ä»¥ä¸‹æ¬„ä½ï¼š</p>

      <div>
        <label for="old_password" class="block text-sm font-medium mb-1">èˆŠå¯†ç¢¼</label>
        <input type="password" id="old_password" name="old_password" class="w-full border p-2" autocomplete="off">
      </div>

      <div>
        <label for="new_password" class="block text-sm font-medium mb-1">æ–°å¯†ç¢¼</label>
        <input type="password" id="new_password" name="new_password" class="w-full border p-2" autocomplete="off">
      </div>

      <div>
        <label for="confirm_password" class="block text-sm font-medium mb-1">ç¢ºèªæ–°å¯†ç¢¼</label>
        <input type="password" id="confirm_password" name="confirm_password" class="w-full border p-2" autocomplete="off">
      </div>

      <div class="flex justify-end space-x-2 pt-2">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 border rounded">å–æ¶ˆ</button>
        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded">å„²å­˜</button>
      </div>
    </form>
  </div>

  <!-- é›™å› ç´ èªè­‰ Modal -->
  <div id="2faModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">é›™å› ç´ èªè­‰ (2FA) ç®¡ç†</h3>
        <button onclick="close2FAModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>

      <!-- 2FA ç‹€æ…‹é¡¯ç¤º -->
      <div id="2fa-modal-status" class="mb-6">
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="text-lg font-medium text-gray-900">ç›®å‰ç‹€æ…‹</h4>
              <p class="text-sm text-gray-600 mt-1">æª¢æŸ¥æ‚¨çš„ 2FA è¨­å®šç‹€æ…‹</p>
            </div>
            <button onclick="check2FAStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                é‡æ–°æ•´ç†
            </button>
          </div>
          <div id="2fa-status-content" class="mt-4">
            <div class="animate-pulse">
              <div class="h-4 bg-gray-200 rounded w-1/4"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2FA è¨­å®šå€åŸŸ -->
      <div id="2fa-setup" class="mb-6 hidden">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="text-lg font-medium text-blue-900 mb-3">è¨­å®šé›™å› ç´ èªè­‰</h4>
          
          <div class="space-y-3">
            <div>
              <p class="text-sm text-blue-700 mb-2">
                è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿè¨­å®š 2FAï¼š
              </p>
              <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                <li>ä¸‹è¼‰ä¸¦å®‰è£ Google Authenticator æ‡‰ç”¨ç¨‹å¼</li>
                <li>é»æ“Šä¸‹æ–¹ã€Œç”Ÿæˆé‡‘é‘°ã€æŒ‰éˆ•</li>
                <li>ä½¿ç”¨ Google Authenticator æŒ‰ç…§æ­¥é©Ÿè¼¸å…¥é‡‘é‘°</li>
                <li>è¼¸å…¥æ‡‰ç”¨ç¨‹å¼é¡¯ç¤ºçš„ 6 ä½æ•¸é©—è­‰ç¢¼</li>
                <li>å®Œæˆè¨­å®š</li>
              </ol>
            </div>

            <div class="flex space-x-3">
              <button onclick="generateQRCode()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                ç”Ÿæˆé‡‘é‘°
              </button>
              <button onclick="showManualSetup()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                æ‰‹å‹•è¨­å®š
              </button>
            </div>
          </div>

          <!-- QR Code é¡¯ç¤ºå€åŸŸ -->
          <div id="qr-code-section" class="hidden mt-4">
            <div class="text-center">
              <div id="qr-code-image" class="mx-auto mb-3"></div>
              <div id="secret-key" class="mb-3">
                <p class="text-sm text-gray-600 mb-1">å¯†é‘°ï¼š</p>
                <code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono" id="secret-display"></code>
              </div>
              <div class="mb-3">
                <label for="verification-code" class="block text-sm font-medium text-gray-700 mb-1">
                  é©—è­‰ç¢¼
                </label>
                <input type="text" id="verification-code" maxlength="6" 
                       class="w-24 text-center px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                       placeholder="000000">
              </div>
              <button onclick="verifyAndEnable2FA()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                é©—è­‰ä¸¦å•Ÿç”¨
              </button>
            </div>
          </div>

          <!-- å‚™ç”¨ç¢¼é¡¯ç¤ºå€åŸŸ -->
          <div id="backup-codes-section" class="hidden mt-4">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
              <h5 class="text-sm font-medium text-yellow-800 mb-2">å‚™ç”¨ç¢¼</h5>
              <p class="text-sm text-yellow-700 mb-2">
                è«‹å°‡ä»¥ä¸‹å‚™ç”¨ç¢¼å®‰å…¨ä¿å­˜ï¼Œç•¶æ‚¨ç„¡æ³•ä½¿ç”¨ Google Authenticator æ™‚å¯ä½¿ç”¨é€™äº›ç¢¼ç™»å…¥ï¼š
              </p>
              <div id="backup-codes-list" class="grid grid-cols-2 gap-1 text-sm font-mono text-yellow-800 mb-2"></div>
              <p class="text-xs text-yellow-600">
                âš ï¸ æ¯å€‹å‚™ç”¨ç¢¼åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œä½¿ç”¨å¾Œæœƒè‡ªå‹•å¤±æ•ˆ
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- 2FA åœç”¨å€åŸŸ -->
      <div id="2fa-disable" class="mb-6 hidden">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="text-lg font-medium text-red-900 mb-3">åœç”¨é›™å› ç´ èªè­‰</h4>
          <p class="text-sm text-red-700 mb-3">
            åœç”¨ 2FA æœƒé™ä½æ‚¨çš„å¸³è™Ÿå®‰å…¨æ€§ã€‚è«‹ç¢ºèªæ‚¨çœŸçš„éœ€è¦åœç”¨æ­¤åŠŸèƒ½ã€‚
          </p>
          
          <div class="space-y-3">
            <div>
              <label for="disable-password" class="block text-sm font-medium text-gray-700 mb-1">
                ç¢ºèªå¯†ç¢¼
              </label>
              <input type="password" id="disable-password" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                     placeholder="è«‹è¼¸å…¥æ‚¨çš„å¯†ç¢¼">
            </div>
            <button onclick="disable2FA()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
              åœç”¨ 2FA
            </button>
          </div>
        </div>
      </div>

      <!-- å‚™ç”¨ç¢¼ç®¡ç† -->
      <div id="backup-codes-management" class="mb-6 hidden">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <h4 class="text-lg font-medium text-green-900 mb-3">å‚™ç”¨ç¢¼ç®¡ç†</h4>
          <p class="text-sm text-green-700 mb-3">
            æŸ¥çœ‹æ‚¨ç›®å‰çš„å‚™ç”¨ç¢¼ç‹€æ…‹
          </p>
          <button onclick="showBackupCodes()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            é¡¯ç¤ºå‚™ç”¨ç¢¼
          </button>
          <div id="current-backup-codes" class="hidden mt-3">
            <div class="bg-white border border-green-200 rounded-lg p-3">
              <h5 class="text-sm font-medium text-green-800 mb-2">ç›®å‰å¯ç”¨çš„å‚™ç”¨ç¢¼</h5>
              <div id="current-backup-codes-list" class="grid grid-cols-2 gap-1 text-sm font-mono text-green-800"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loginLogModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow-lg w-[600px] max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
      <h2 class="text-xl font-bold mb-4">ç™»å…¥è¨˜éŒ„</h2>
      <table class="w-full table-auto border">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">IP</th>
            <th class="p-2 border">æ™‚é–“</th>
          </tr>
        </thead>
        <tbody id="login-log-body"></tbody>
      </table>
      <div class="text-right mt-4">
        <button onclick="closeLoginLogModal()" class="px-4 py-2 bg-gray-300 rounded">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- IP é–å®šç®¡ç† Modal -->
  <div id="ipLockoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow w-full max-w-6xl max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">ğŸ”’ IP é–å®šç®¡ç†</h3>
        <button onclick="closeIPLockoutModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
        <div class="flex items-center space-x-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600" id="total-locked-ips">0</div>
            <div class="text-sm text-blue-600">è¢«é–å®š IP</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600" id="total-unlocked-ips">0</div>
            <div class="text-sm text-green-600">å·²è§£é™¤é–å®š</div>
          </div>
        </div>
      </div>
      
      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="mb-4 flex space-x-2">
        <button onclick="refreshIPLockoutList()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
        <button onclick="unlockAllIPs()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          ğŸ”“ è§£é™¤æ‰€æœ‰é–å®š
        </button>
      </div>
      
      <!-- IP åˆ—è¡¨ -->
      <div class="overflow-x-auto">
        <table class="w-full border">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2 border text-left">IP åœ°å€</th>
              <th class="p-2 border text-center">å¤±æ•—æ¬¡æ•¸</th>
              <th class="p-2 border text-center">é–å®šåˆ°æœŸæ™‚é–“</th>
              <th class="p-2 border text-center">å‰©é¤˜æ™‚é–“</th>
              <th class="p-2 border text-center">æœ€å¾Œå¤±æ•—æ™‚é–“</th>
              <th class="p-2 border text-center">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="ip-lockout-body">
            <tr>
              <td class="p-2 border text-center" colspan="6">è¼‰å…¥ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- è¼‰å…¥ä¸­ -->
      <div id="ip-lockout-loading" class="hidden mt-4 text-center">
        <div class="inline-flex items-center">
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="text-blue-600">è™•ç†ä¸­...</span>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const districtSelect = document.querySelector('select[name="district"]');
  const villageSelect = document.querySelector('select[name="village"]');

  const selectedDistrictId = {{ current_user.district_id or 'null' }};
  const selectedVillageId = {{ current_user.village_id or 'null' }};

  fetch("/api/districts")
    .then(res => res.json())
    .then(data => {
      districtSelect.innerHTML = '<option value="">è«‹é¸æ“‡è¡Œæ”¿å€</option>';
      data.forEach(d => {
        const option = document.createElement("option");
        option.value = d.id;
        option.textContent = d.name;
        if (selectedDistrictId === d.id) {
          option.selected = true;
        }
        districtSelect.appendChild(option);
      });

      // è¼‰å…¥è©²å€å°æ‡‰çš„é‡Œï¼Œä¸¦é¸å®š villageId
      if (selectedDistrictId !== null) {
        // loadVillages(selectedDistrictId, selectedVillageId);
      }
    });

  // è¼‰å…¥ 2FA ç‹€æ…‹
  check2FAStatus();
});

// åŠ å…¥å¯†ç¢¼æ›´æ–°æ™‚é–“æª¢æŸ¥
const passwordUpdatedAt = "{{ current_user.password_updated_at }}";
if (passwordUpdatedAt) {
  const updatedDate = new Date(passwordUpdatedAt);
  const now = new Date();
  const diffDays = (now - updatedDate) / (1000 * 60 * 60 * 24);
  if (diffDays > 90) {
    alert("æ‚¨çš„å¯†ç¢¼å·²è¶…é 90 å¤©æœªè®Šæ›´ï¼Œè«‹ç›¡å¿«æ›´æ–°å¯†ç¢¼");
  }
}

function openEditModal() {
  document.getElementById("editModal").classList.remove("hidden");
}

function closeEditModal() {
  document.getElementById("editModal").classList.add("hidden");
}

function open2FAModal() {
  document.getElementById("2faModal").classList.remove("hidden");
  check2FAStatus(); // é‡æ–°æª¢æŸ¥ç‹€æ…‹
}

function close2FAModal() {
  document.getElementById("2faModal").classList.add("hidden");
}

function closeLoginLogModal() {
  document.getElementById('loginLogModal').classList.add('hidden');
}

function showIPLockoutManagement() {
  document.getElementById('ipLockoutModal').classList.remove('hidden');
  refreshIPLockoutList();
}

function closeIPLockoutModal() {
  document.getElementById('ipLockoutModal').classList.add('hidden');
}

// 2FA ç›¸é—œå‡½æ•¸
async function check2FAStatus() {
  try {
    const response = await fetch('/api/2fa/status');
    const data = await response.json();
    
    if (data.status === 'success') {
      display2FAStatus(data.enabled, data.has_backup_codes);
      updateProfile2FAStatus(data.enabled); // æ›´æ–° profile é é¢çš„ç‹€æ…‹
    } else {
      showError('ç„¡æ³•å–å¾— 2FA ç‹€æ…‹');
    }
  } catch (error) {
    console.error('Error:', error);
    showError('æª¢æŸ¥ 2FA ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤');
  }
}

function updateProfile2FAStatus(enabled) {
  const statusText = document.getElementById('2fa-status-text');
  if (enabled) {
    statusText.textContent = 'å·²å•Ÿç”¨ - æ‚¨çš„å¸³è™Ÿå—åˆ°é›™å› ç´ èªè­‰ä¿è­·';
    statusText.className = 'text-sm text-green-600';
  } else {
    statusText.textContent = 'æœªå•Ÿç”¨ - å»ºè­°å•Ÿç”¨ä»¥å¢å¼·å¸³è™Ÿå®‰å…¨æ€§';
    statusText.className = 'text-sm text-red-600';
  }
}

function display2FAStatus(enabled, hasBackupCodes) {
  const statusContent = document.getElementById('2fa-status-content');
  const setupSection = document.getElementById('2fa-setup');
  const disableSection = document.getElementById('2fa-disable');
  const backupSection = document.getElementById('backup-codes-management');

  if (enabled) {
    statusContent.innerHTML = `
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-green-800">2FA å·²å•Ÿç”¨</p>
          <p class="text-sm text-green-600">æ‚¨çš„å¸³è™Ÿå—åˆ°é›™å› ç´ èªè­‰ä¿è­·</p>
        </div>
      </div>
    `;
    
    setupSection.classList.add('hidden');
    disableSection.classList.remove('hidden');
    backupSection.classList.remove('hidden');
  } else {
    statusContent.innerHTML = `
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-red-800">2FA æœªå•Ÿç”¨</p>
          <p class="text-sm text-red-600">å»ºè­°å•Ÿç”¨é›™å› ç´ èªè­‰ä»¥å¢å¼·å¸³è™Ÿå®‰å…¨æ€§</p>
        </div>
      </div>
    `;
    
    setupSection.classList.remove('hidden');
    disableSection.classList.add('hidden');
    backupSection.classList.add('hidden');
  }
}

async function generateQRCode() {
  try {
    const response = await fetch('/api/2fa/setup', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      // é¡¯ç¤ºæ‰‹å‹•è¨­å®šèªªæ˜
      document.getElementById('qr-code-image').innerHTML = data.setup_instructions;
      document.getElementById('secret-display').textContent = data.secret;
      document.getElementById('qr-code-section').classList.remove('hidden');
    } else {
      showError(data.message || 'ç”Ÿæˆè¨­å®šèªªæ˜å¤±æ•—');
    }
  } catch (error) {
    console.error('Error:', error);
    showError('ç”Ÿæˆè¨­å®šèªªæ˜æ™‚ç™¼ç”ŸéŒ¯èª¤');
  }
}

function showManualSetup() {
  document.getElementById('qr-code-section').classList.remove('hidden');
  document.getElementById('qr-code-image').innerHTML = `
    <div class="text-center text-gray-500">
      <svg class="h-20 w-20 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"></path>
      </svg>
      <p class="text-sm">è«‹æ‰‹å‹•è¼¸å…¥å¯†é‘°åˆ° Google Authenticator</p>
    </div>
  `;
}

async function verifyAndEnable2FA() {
  const code = document.getElementById('verification-code').value.trim();
  
  if (!code || code.length !== 6) {
    showError('è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼');
    return;
  }
  
  try {
    const response = await fetch('/api/2fa/verify-setup', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ token: code })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('2FA è¨­å®šæˆåŠŸï¼');
      displayBackupCodes(data.backup_codes);
      check2FAStatus(); // é‡æ–°æª¢æŸ¥ç‹€æ…‹
    } else {
      showError(data.message || 'é©—è­‰å¤±æ•—');
    }
  } catch (error) {
    console.error('Error:', error);
    showError('é©—è­‰æ™‚ç™¼ç”ŸéŒ¯èª¤');
  }
}

function displayBackupCodes(backupCodes) {
  const backupCodesList = document.getElementById('backup-codes-list');
  backupCodesList.innerHTML = backupCodes.map(code => `<div>${code}</div>`).join('');
  document.getElementById('backup-codes-section').classList.remove('hidden');
}

async function disable2FA() {
  const password = document.getElementById('disable-password').value.trim();
  
  if (!password) {
    showError('è«‹è¼¸å…¥å¯†ç¢¼');
    return;
  }
  
  try {
    const response = await fetch('/api/2fa/disable', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ password: password })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccess('2FA å·²åœç”¨');
      document.getElementById('disable-password').value = '';
      check2FAStatus(); // é‡æ–°æª¢æŸ¥ç‹€æ…‹
    } else {
      showError(data.message || 'åœç”¨å¤±æ•—');
    }
  } catch (error) {
    console.error('Error:', error);
    showError('åœç”¨æ™‚ç™¼ç”ŸéŒ¯èª¤');
  }
}

async function showBackupCodes() {
  try {
    const response = await fetch('/api/2fa/backup-codes');
    const data = await response.json();
    
    if (data.status === 'success') {
      const backupCodesList = document.getElementById('current-backup-codes-list');
      backupCodesList.innerHTML = data.backup_codes.map(code => `<div>${code}</div>`).join('');
      document.getElementById('current-backup-codes').classList.remove('hidden');
    } else {
      showError(data.message || 'ç„¡æ³•å–å¾—å‚™ç”¨ç¢¼');
    }
  } catch (error) {
    console.error('Error:', error);
    showError('å–å¾—å‚™ç”¨ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤');
  }
}

function showSuccess(message) {
  alert('æˆåŠŸï¼š' + message);
}

function showError(message) {
  alert('éŒ¯èª¤ï¼š' + message);
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'å·²è¤‡è£½ï¼';
    button.classList.add('text-green-600');
    
    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove('text-green-600');
    }, 2000);
  }).catch(err => {
    console.error('è¤‡è£½å¤±æ•—:', err);
    // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±æ–¹æ³•
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'å·²è¤‡è£½ï¼';
    button.classList.add('text-green-600');
    
    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove('text-green-600');
    }, 2000);
  });
}

async function showOwnLoginLogs() {
  const userId = {{ current_user.id }};
  const res = await fetch(`/api/login_logs/${userId}`);
  const { logs } = await res.json();
  const tbody = document.getElementById('login-log-body');
  tbody.innerHTML = '';

  if (logs.length === 0) {
    tbody.innerHTML = `<tr><td class="p-2 border text-center" colspan="2">ç„¡ç™»å…¥ç´€éŒ„</td></tr>`;
  } else {
    logs.forEach(log => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2 border">${log.ip}</td>
        <td class="p-2 border">${log.login_time}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('loginLogModal').classList.remove('hidden');
}

document.getElementById("editForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const phone = document.getElementById("phone").value.trim();
  const district = document.getElementById("district").value;
  const oldPw = document.getElementById("old_password").value.trim();
  const newPw = document.getElementById("new_password").value.trim();
  const confirmPw = document.getElementById("confirm_password").value.trim();

  // è‹¥æœ‰è¦æ”¹å¯†ç¢¼ï¼ˆå…¶ä¸­ä»»ä¸€æ¬„æœ‰è¼¸å…¥ï¼‰
  if (oldPw || newPw || confirmPw) {
    // æª¢æŸ¥æ˜¯å¦æœ‰å¡«å®Œä¸‰æ¬„
    if (!oldPw || !newPw || !confirmPw) {
      alert("è«‹å®Œæ•´å¡«å¯«èˆŠå¯†ç¢¼ã€æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼");
      e.preventDefault();
      return;
    }

    // æª¢æŸ¥æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼æ˜¯å¦ä¸€è‡´
    if (newPw !== confirmPw) {
      alert("æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´");
      e.preventDefault();
      return;
    }

    // æª¢æŸ¥å¯†ç¢¼è¤‡é›œåº¦
    const pwRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-zA-Z0-9]).{12,}$/;
    if (!pwRegex.test(newPw)) {
      alert("å¯†ç¢¼éœ€è‡³å°‘12ç¢¼ï¼ŒåŒ…å«å¤§å°å¯«è‹±æ–‡ã€æ•¸å­—èˆ‡ç‰¹æ®Šç¬¦è™Ÿ");
      e.preventDefault();
      return;
    }
  }

  const formData = {
    phone,
    district,
    old_password: oldPw,
    new_password: newPw,
    confirm_password: confirmPw
  };

  const res = await fetch("/profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(formData)
  });

  const result = await res.json();
  showModalMessage(result.message, result.status);
});

function showModalMessage(msg, status) {
  const color = status === "success" ? "bg-green-600" : "bg-red-600";
  const container = document.createElement("div");
  container.className = `mb-2 px-3 py-2 rounded text-white text-sm ${color}`;
  container.textContent = msg;

  const form = document.getElementById("editForm");
  const oldMsg = form.querySelector(".modal-message");
  if (oldMsg) oldMsg.remove();

  container.classList.add("modal-message");
  form.prepend(container);

  document.getElementById("old_password").value = "";
  document.getElementById("new_password").value = "";
  document.getElementById("confirm_password").value = "";
}

// IP é–å®šç®¡ç†ç›¸é—œå‡½æ•¸
async function refreshIPLockoutList() {
  try {
    showIPLockoutLoading(true);
    
    const response = await fetch('/api/ip-lockout/admin/list');
    const data = await response.json();
    
    if (data.status === 'success') {
      displayIPLockoutList(data.locked_ips);
      updateIPLockoutStats(data.total_count);
    } else {
      showIPLockoutError(data.message || 'è¼‰å…¥å¤±æ•—');
    }
  } catch (error) {
    console.error('Error:', error);
    showIPLockoutError('è¼‰å…¥ IP é–å®šåˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤');
  } finally {
    showIPLockoutLoading(false);
  }
}

function displayIPLockoutList(lockedIPs) {
  const tbody = document.getElementById('ip-lockout-body');
  
  if (lockedIPs.length === 0) {
    tbody.innerHTML = '<tr><td class="p-2 border text-center" colspan="6">ç›®å‰æ²’æœ‰è¢«é–å®šçš„ IP</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  
  lockedIPs.forEach(ip => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2 border font-mono">${ip.ip_address}</td>
      <td class="p-2 border text-center">${ip.failed_attempts}</td>
      <td class="p-2 border text-center">${formatDateTime(ip.locked_until)}</td>
      <td class="p-2 border text-center">
        <span class="px-2 py-1 rounded text-xs ${ip.remaining_time === 'å·²éæœŸ' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
          ${ip.remaining_time || 'æœªçŸ¥'}
        </span>
      </td>
      <td class="p-2 border text-center">${formatDateTime(ip.last_failed_at)}</td>
      <td class="p-2 border text-center">
        <button onclick="unlockSpecificIP('${ip.ip_address}')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
          ğŸ”“ è§£é™¤é–å®š
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function updateIPLockoutStats(totalLocked) {
  document.getElementById('total-locked-ips').textContent = totalLocked;
  document.getElementById('total-unlocked-ips').textContent = '0'; // å¯ä»¥æ ¹æ“šéœ€è¦è¨ˆç®—
}

async function unlockSpecificIP(ipAddress) {
  if (!confirm(`ç¢ºå®šè¦è§£é™¤ IP ${ipAddress} çš„é–å®šå—ï¼Ÿ`)) {
    return;
  }
  
  try {
    showIPLockoutLoading(true);
    
    const response = await fetch('/api/ip-lockout/admin/unlock', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ ip_address: ipAddress })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      alert(`âœ… ${data.message}`);
      refreshIPLockoutList(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
    } else {
      alert(`âŒ ${data.message}`);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('è§£é™¤é–å®šæ™‚ç™¼ç”ŸéŒ¯èª¤');
  } finally {
    showIPLockoutLoading(false);
  }
}

async function unlockAllIPs() {
  if (!confirm('ç¢ºå®šè¦è§£é™¤æ‰€æœ‰ IP çš„é–å®šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼')) {
    return;
  }
  
  try {
    showIPLockoutLoading(true);
    
    // ç²å–æ‰€æœ‰è¢«é–å®šçš„ IP
    const response = await fetch('/api/ip-lockout/admin/list');
    const data = await response.json();
    
    if (data.status !== 'success' || data.locked_ips.length === 0) {
      alert('æ²’æœ‰æ‰¾åˆ°è¢«é–å®šçš„ IP');
      return;
    }
    
    // é€ä¸€è§£é™¤é–å®š
    let successCount = 0;
    for (const ip of data.locked_ips) {
      try {
        const unlockResponse = await fetch('/api/ip-lockout/admin/unlock', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ip_address: ip.ip_address })
        });
        
        const unlockData = await unlockResponse.json();
        if (unlockData.status === 'success') {
          successCount++;
        }
      } catch (error) {
        console.error(`è§£é™¤ IP ${ip.ip_address} é–å®šå¤±æ•—:`, error);
      }
    }
    
    alert(`âœ… æˆåŠŸè§£é™¤ ${successCount} å€‹ IP çš„é–å®š`);
    refreshIPLockoutList(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
    
  } catch (error) {
    console.error('Error:', error);
    alert('æ‰¹é‡è§£é™¤é–å®šæ™‚ç™¼ç”ŸéŒ¯èª¤');
  } finally {
    showIPLockoutLoading(false);
  }
}

function showIPLockoutLoading(show) {
  const loading = document.getElementById('ip-lockout-loading');
  if (show) {
    loading.classList.remove('hidden');
  } else {
    loading.classList.add('hidden');
  }
}

function showIPLockoutError(message) {
  alert(`âŒ ${message}`);
}

function formatDateTime(dateTimeStr) {
  if (!dateTimeStr) return 'N/A';
  
  try {
    const date = new Date(dateTimeStr);
    return date.toLocaleString('zh-TW');
  } catch (error) {
    return dateTimeStr;
  }
}
</script>
{% endblock %}
